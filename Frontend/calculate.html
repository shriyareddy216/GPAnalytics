<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CGPA Calculation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --panel-2: #1a2438;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --brand: #7c3aed;
      --brand-2: #6d28d9;
      --accent: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #0ea5e9;
      --radius: 16px;
      --shadow: 0 10px 24px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
      --gradient: linear-gradient(135deg, #7c3aed 0%, #10b981 100%);
      --success: rgba(16, 185, 129, 0.15);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      height: 100%;
      font-family: 'Inter', ui-sans-serif, system-ui;
      background: radial-gradient(ellipse at top left, #1e293b 0%, #0f172a 70%);
      color: var(--text);
    }
    
    .navbar { 
      background: var(--panel); 
      display: flex; 
      justify-content: space-between; 
      padding: 16px 24px; 
      align-items: center;
      box-shadow: var(--shadow);
    }
    
    .navbar h2 { 
      font-size: 18px; 
      font-weight: 700; 
      background: var(--gradient); 
      -webkit-background-clip: text; 
      background-clip: text; 
      color: transparent; 
    }
    
    .nav-links { 
      display: flex; 
      gap: 20px; 
    }
    
    .nav-links a { 
      color: var(--muted); 
      text-decoration: none; 
      font-size: 14px; 
      transition: color 0.3s ease;
    }
    
    .nav-links a:hover { 
      color: var(--text); 
    }
    
    body { 
      display: flex; 
      flex-direction: column; 
    }
    
    .container { 
      flex: 1; 
      max-width: 1200px; 
      margin: 30px auto; 
      padding: 20px; 
      width: 100%;
    }
    
    .card { 
      background: var(--panel); 
      border-radius: var(--radius); 
      margin-bottom: 24px; 
      position: relative; 
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    .card::before { 
      content: ''; 
      position: absolute; 
      top: 0; 
      left: 0; 
      right: 0; 
      height: 6px; 
      background: var(--gradient); 
    }
    
    .card__header { 
      padding: 24px; 
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }
    
    .card__header h1 { 
      font-size: 24px; 
      font-weight: 700; 
      margin-bottom: 8px;
    }
    
    .muted {
      color: var(--muted);
      font-size: 14px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--panel-2);
      margin-bottom: 24px;
      border-radius: var(--radius);
      overflow: hidden;
      font-size: 14px;
    }

    /* Header styling */
    th {
      background: rgba(124, 58, 237, 0.2);
      font-weight: 600;
      font-size: 13px;
      text-align: center;
      padding: 12px 8px;
      color: var(--text);
      position: sticky;
      top: 0;
    }

    /* Body rows */
    td {
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      text-align: center;
    }

    /* Zebra striping */
    tbody tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Hover highlight */
    tbody tr:hover {
      background: rgba(124, 58, 237, 0.12);
    }

    /* Input and select box styles */
    input, select {
      width: 90px;
      padding: 8px;
      border-radius: 8px;
      background: var(--panel);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 13px;
      text-align: center;
      transition: all 0.2s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3);
    }

    input::placeholder {
      color: var(--muted);
      font-size: 12px;
    }

    select {
      width: 100px;
      cursor: pointer;
    }
    
    .btn-container {
      display: flex;
      justify-content: center;
      gap: 16px;
      padding: 0 24px;
      margin-bottom: 24px;
    }
    
    .btn { 
      padding: 14px 20px; 
      border-radius: 12px; 
      background: var(--gradient); 
      color: white; 
      font-weight: 600; 
      cursor: pointer; 
      border: none;
      transition: all 0.3s ease;
      min-width: 140px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    .btn-secondary {
      background: var(--panel-2);
      color: var(--text);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .result { 
      padding: 20px; 
      background: var(--success); 
      border-radius: 12px; 
      margin: 0 24px 24px; 
      text-align: center;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .result-value { 
      font-size: 42px; 
      font-weight: 800; 
      background: var(--gradient); 
      -webkit-background-clip: text; 
      background-clip: text; 
      color: transparent; 
      margin: 10px 0;
    }
    
    .hidden {
      display: none !important;
    }
    
    .subject-name {
      font-weight: 500;
      text-align: left;
      padding-left: 16px;
    }
    
    .table-container {
      overflow-x: auto;
      margin: 0 0 24px 0;
      padding: 0 16px;
    }
    
    .table-scroll {
      min-width: 1200px;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      background: var(--panel);
      color: var(--text);
      box-shadow: var(--shadow);
      transform: translateX(150%);
      transition: transform 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      border-left: 4px solid var(--accent);
    }
    
    .notification.error {
      border-left: 4px solid var(--danger);
    }
    
    .grade-breakdown {
      padding: 16px 24px;
      margin: 0 24px 24px;
      background: var(--panel-2);
      border-radius: 12px;
    }
    
    .grade-breakdown h3 {
      margin-bottom: 16px;
      font-size: 18px;
      color: var(--muted);
    }
    
    .grade-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .grade-table th {
      background: rgba(16, 185, 129, 0.1);
    }
    
    .grade-table td:first-child,
    .grade-table th:first-child {
      text-align: left;
      padding-left: 16px;
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--brand);
      animation: spin 1s linear infinite;
    }
    
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 16px;
        padding: 16px;
      }
      
      .nav-links {
        width: 100%;
        justify-content: center;
      }
      
      .container {
        padding: 10px;
      }
      
      .card__header {
        padding: 16px;
      }
      
      .btn-container {
        flex-direction: column;
        padding: 0 16px;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <h2>GPAnalytics Dashboard</h2>
    <div class="nav-links">
      <a href="cgpa.html">Previous Data</a>
      <a href="calculate.html" style="color: var(--brand);">Calculate CGPA</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
  </nav>

  <div class="container">
    <section class="card">
      <header class="card__header">
        <h1>ðŸ“Š CGPA Calculator</h1>
        <p class="muted">Estimate your CGPA by entering your subject scores and credits. Values will be automatically validated.</p>
      </header>

      <div class="table-container">
        <div class="table-scroll">
          <!-- Subjects Table -->
          <table id="cgpaTable">
            <thead>
              <tr>
                <th>Subject</th>
                <th>Credits</th>
                <th>Assignment-1 (10)</th>
                <th>Assignment-2 (10)</th>
                <th>ST-1 (5)</th>
                <th>ST-2 (5)</th>
                <th>ST-3 (5)</th>
                <th>Attendance (5)</th>
                <th>Mid-1 (20)</th>
                <th>Mid-2 (20)</th>
                <th>External (60)</th>
                <th>Difficulty</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="12" class="loading">
                  <div class="spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="table-container">
        <div class="table-scroll">
          <!-- Labs Table -->
          <table id="labTable">
            <thead>
              <tr>
                <th>Lab Subject</th>
                <th>Credits</th>
                <th>Internal-1 (20)</th>
                <th>Internal-2 (20)</th>
                <th>CIE (30)</th>
                <th>External (50)</th>
                <th>Difficulty</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="loading">
                  <div class="spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="btn-container">
        <button id="calculateBtn" class="btn">Calculate CGPA</button>
        <button id="resetBtn" class="btn btn-secondary">Reset Form</button>
      </div>

      <div id="result" class="result hidden">
        <h3>Estimated CGPA</h3>
        <div id="cgpaValue" class="result-value">â€”</div>
        <p class="muted">Based on your input values and difficulty adjustments</p>
      </div>

      <div id="gradeBreakdown" class="grade-breakdown hidden">
        <h3>Subject-wise Grade Breakdown</h3>
        <table class="grade-table">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Credits</th>
              <th>Total Score</th>
              <th>Grade Point</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="breakdownBody">
            <!-- Will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="notification" class="notification hidden">
    <span id="notificationMessage"></span>
  </div>

  <script>
    // DOM Elements
    const tbody = document.querySelector("#cgpaTable tbody");
    const labTbody = document.querySelector("#labTable tbody");
    const calculateBtn = document.getElementById("calculateBtn");
    const resetBtn = document.getElementById("resetBtn");
    const resultDiv = document.getElementById("result");
    const cgpaValue = document.getElementById("cgpaValue");
    const gradeBreakdown = document.getElementById("gradeBreakdown");
    const breakdownBody = document.getElementById("breakdownBody");
    const notification = document.getElementById("notification");
    const notificationMessage = document.getElementById("notificationMessage");
    // Show notification function
    function showNotification(message, type = "success") {
      notificationMessage.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove("show");
      }, 3000);
    }

    // Validate input values with maximum limits
    function validateInput(input, max) {
      const value = parseFloat(input.value);
      if (isNaN(value)) {
        input.value = "";
        return 0;
      }
      
      if (value > max) {
        input.value = max;
        showNotification(`Value cannot exceed ${max}. Adjusted to maximum.`, "error");
        return max;
      }
      
      if (value < 0) {
        input.value = 0;
        showNotification("Value cannot be negative. Adjusted to 0.", "error");
        return 0;
      }
      
      return value;
    }

    // Calculate grade from score
    function calculateGrade(score) {
      if (score >= 90) return { grade: 'S', point: 10 };
      if (score >= 80) return { grade: 'A', point: 9 };
      if (score >= 70) return { grade: 'B', point: 8 };
      if (score >= 60) return { grade: 'C', point: 7 };
      if (score >= 50) return { grade: 'D', point: 6 };
      if (score >= 40) return { grade: 'E', point: 5 };
      return { grade: 'F', point: 0 };
    }

    // Logout function
    function logout() {
      sessionStorage.removeItem("erp_username");
      sessionStorage.removeItem("erp_password");
      window.location.href = "index.html";
    }

    // Load subjects from server
    async function loadSubjects() {
      
      const username = sessionStorage.getItem("erp_username");
      const password = sessionStorage.getItem("erp_password");

      if (!username || !password) {
        showNotification("Please login again", "error");
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
        return;
      }

      try {
        const res = await fetch("http://localhost:3000/fetch-data", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (!res.ok || data.error) {
          throw new Error(data.error || "Failed to fetch subjects");
        }

        // Clear loading indicator
        tbody.innerHTML = "";
        labTbody.innerHTML = "";
        
        data.subjects.forEach(sub => {
          const tr = document.createElement("tr");
          if (sub.toUpperCase().includes("LAB")) {
            tr.innerHTML = `
              <td class="subject-name">${sub}</td>
              <td><input type="number" min="1" max="5" placeholder="Credits" class="credit-input"></td>
              <td><input type="number" min="0" max="20" placeholder="0-20" class="score-input" data-max="20"></td>
              <td><input type="number" min="0" max="20" placeholder="0-20" class="score-input" data-max="20"></td>
              <td><input type="number" min="0" max="30" placeholder="0-30" class="score-input" data-max="30"></td>
              <td><input type="number" min="0" max="50" placeholder="0-50" class="score-input" data-max="50"></td>
              <td>
                <select class="difficulty-select">
                  <option value="easy">Easy</option>
                  <option value="medium">Medium</option>
                  <option value="hard">Hard</option>
                </select>
              </td>
            `;
            labTbody.appendChild(tr);
          } else {
            tr.innerHTML = `
              <td class="subject-name">${sub}</td>
              <td><input type="number" min="1" max="5" placeholder="Credits" class="credit-input"></td>
              <td><input type="number" min="0" max="10" placeholder="0-10" class="score-input" data-max="10"></td>
              <td><input type="number" min="0" max="10" placeholder="0-10" class="score-input" data-max="10"></td>
              <td><input type="number" min="0" max="5" placeholder="0-5" class="score-input" data-max="5"></td>
              <td><input type="number" min="0" max="5" placeholder="0-5" class="score-input" data-max="5"></td>
              <td><input type="number" min="0" max="5" placeholder="0-5" class="score-input" data-max="5"></td>
              <td><input type="number" min="0" max="5" placeholder="0-5" class="score-input" data-max="5"></td>
              <td><input type="number" min="0" max="20" placeholder="0-20" class="score-input" data-max="20"></td>
              <td><input type="number" min="0" max="20" placeholder="0-20" class="score-input" data-max="20"></td>
              <td><input type="number" min="0" max="60" placeholder="0-60" class="score-input" data-max="60"></td>
              <td>
                <select class="difficulty-select">
                  <option value="easy">Easy</option>
                  <option value="medium">Medium</option>
                  <option value="hard">Hard</option>
                </select>
              </td>
            `;
            tbody.appendChild(tr);
          }
        });

        // Add input validation
        document.querySelectorAll('.score-input').forEach(input => {
          const max = parseInt(input.getAttribute('data-max'));
          input.addEventListener('change', () => validateInput(input, max));
          input.addEventListener('blur', () => validateInput(input, max));
        });

        // Add credit validation
        document.querySelectorAll('.credit-input').forEach(input => {
          input.addEventListener('change', () => validateInput(input, 5));
          input.addEventListener('blur', () => validateInput(input, 5));
        });

      } catch (err) {
        console.error(err);
        showNotification("Error loading subjects: " + err.message, "error");
      } finally {
        hideLoading();
      }
    }

    // Calculate CGPA
    function calculateCGPA() {
      let totalCredits = 0;
      let weightedSum = 0;
      let allSubjectsValid = true;
      const breakdown = [];

      // Regular Subjects
      [...tbody.rows].forEach(row => {
        const subjectName = row.cells[0].textContent;
        const creditsInput = row.cells[1].querySelector("input");
        const credits = parseFloat(creditsInput.value) || 0;
        
        // Check if credits are entered
        if (credits <= 0) {
          creditsInput.style.borderColor = "var(--danger)";
          allSubjectsValid = false;
        } else {
          creditsInput.style.borderColor = "";
        }
        
        const a1 = parseFloat(row.cells[2].querySelector("input").value) || 0;
        const a2 = parseFloat(row.cells[3].querySelector("input").value) || 0;
        const st1 = parseFloat(row.cells[4].querySelector("input").value) || 0;
        const st2 = parseFloat(row.cells[5].querySelector("input").value) || 0;
        const st3 = parseFloat(row.cells[6].querySelector("input").value) || 0;
        const att = parseFloat(row.cells[7].querySelector("input").value) || 0;
        const mid1 = parseFloat(row.cells[8].querySelector("input").value) || 0;
        const mid2 = parseFloat(row.cells[9].querySelector("input").value) || 0;
        const ext = parseFloat(row.cells[10].querySelector("input").value) || 0;
        const difficulty = row.cells[11].querySelector("select").value;

        const assignmentAvg = (a1 + a2) / 2;
        const sts = [st1, st2, st3].sort((a, b) => b - a).slice(0, 2);
        const stAvg = sts.length ? (sts[0] + sts[1]) / 2 : 0;

        let internal = assignmentAvg + stAvg + att + mid1 + mid2;
        let score = internal + ext;
        
        // Apply difficulty adjustment
        let adjustment = 1;
        if (difficulty === "medium") adjustment = 0.95;
        if (difficulty === "hard") adjustment = 0.9;
        
        const adjustedScore = score * adjustment;
        const gradeInfo = calculateGrade(adjustedScore);
        
        if (credits > 0) {
          weightedSum += gradeInfo.point * credits;
          totalCredits += credits;
        }
        
        breakdown.push({
          name: subjectName,
          credits: credits,
          score: adjustedScore,
          grade: gradeInfo.grade,
          point: gradeInfo.point,
          status: gradeInfo.point > 0 ? "Pass" : "Fail"
        });
      });

      // Lab Subjects
      [...labTbody.rows].forEach(row => {
        const subjectName = row.cells[0].textContent;
        const creditsInput = row.cells[1].querySelector("input");
        const credits = parseFloat(creditsInput.value) || 0;
        
        // Check if credits are entered
        if (credits <= 0) {
          creditsInput.style.borderColor = "var(--danger)";
          allSubjectsValid = false;
        } else {
          creditsInput.style.borderColor = "";
        }
        
        const int1 = parseFloat(row.cells[2].querySelector("input").value) || 0;
        const int2 = parseFloat(row.cells[3].querySelector("input").value) || 0;
        const cie = parseFloat(row.cells[4].querySelector("input").value) || 0;
        const ext = parseFloat(row.cells[5].querySelector("input").value) || 0;
        const difficulty = row.cells[6].querySelector("select").value;

        const internalAvg = (int1 + int2) / 2;
        let internal = internalAvg + cie;
        if (internal > 50) internal = 50;

        let score = internal + ext;
        
        // Apply difficulty adjustment
        let adjustment = 1;
        if (difficulty === "medium") adjustment = 0.95;
        if (difficulty === "hard") adjustment = 0.9;
        
        const adjustedScore = score * adjustment;
        const gradeInfo = calculateGrade(adjustedScore);
        
        if (credits > 0) {
          weightedSum += gradeInfo.point * credits;
          totalCredits += credits;
        }
        
        breakdown.push({
          name: subjectName,
          credits: credits,
          score: adjustedScore,
          grade: gradeInfo.grade,
          point: gradeInfo.point,
          status: gradeInfo.point > 0 ? "Pass" : "Fail"
        });
      });

      if (!allSubjectsValid) {
        showNotification("Please enter credits for all subjects", "error");
        return;
      }

      if (totalCredits === 0) {
        showNotification("Please enter at least one subject with credits", "error");
        return;
      }

      const cgpa = (weightedSum / totalCredits).toFixed(2);
      resultDiv.classList.remove("hidden");
      cgpaValue.textContent = cgpa;
      
      // Show grade breakdown
      gradeBreakdown.classList.remove("hidden");
      breakdownBody.innerHTML = "";
      
      breakdown.forEach(subject => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${subject.name}</td>
          <td>${subject.credits}</td>
          <td>${subject.score.toFixed(2)}</td>
          <td>${subject.grade} (${subject.point})</td>
          <td style="color: ${subject.status === 'Pass' ? 'var(--accent)' : 'var(--danger)'}">${subject.status}</td>
        `;
        breakdownBody.appendChild(tr);
      });
      
      showNotification(`CGPA calculated successfully: ${cgpa}`);
    }

    // Reset form
    function resetForm() {
      document.querySelectorAll('input').forEach(input => {
        input.value = '';
        input.style.borderColor = '';
      });
      
      document.querySelectorAll('select').forEach(select => {
        select.selectedIndex = 0;
      });
      
      resultDiv.classList.add("hidden");
      gradeBreakdown.classList.add("hidden");
      
      showNotification("Form has been reset");
    }

    // Event listeners
    calculateBtn.addEventListener("click", calculateCGPA);
    resetBtn.addEventListener("click", resetForm);

    // Initialize
    loadSubjects();
  </script>
</body>
</html>